pipeline {
<<<<<<< HEAD
    agent any

    environment {
        IMAGE_NAME = "tip_top_frontend"
        CONTAINER_NAME = "tip_top_frontend_container"
        DOCKER_REGISTRY = "docker.io/your-dockerhub-username"
    }

    stages {
        stage('Checkout Code') {
            steps {
                git branch: 'main', url: 'https://github.com/Laminaacharaf/TheTipTop.git'
            }
        }

        stage('Install Dependencies') {
            steps {
=======
    tools {
        nodejs 'NodeJS_20' // Utilise NodeJS 20 configurÃ© dans Jenkins
    }

    agent {
        docker {
            image 'node:20'
        }
    }

    environment {
        NODE_ENV = 'production'
        SONAR_HOST_URL = 'https://www.sonarqube.dsp5-archi-f24a-15m-g8.fr'
        SONAR_TOKEN = credentials('sonarqube-token')
        GIT_REPO = 'https://github.com/Acharaf-Dev/THETIPTOP_GAME.git'
        DOCKER_IMAGE = "tiptop_frontend:${env.BRANCH_NAME}-${env.BUILD_NUMBER}"
        DOCKER_TAG_LATEST = "tiptop_frontend:${env.BRANCH_NAME}"
        SSH_CREDENTIALS = 'vps-ssh-key'
        VPS_USER = 'root'
        VPS_HOST = '161.97.76.223'
        CONTAINER_NAME = 'tip_top_frontend'
        PROJECT_PATH = '/root/THETIPTOP_GAME/frontend'
    }

    stages {
        stage('ðŸ“¥ Checkout') {
            steps {
                git branch: env.BRANCH_NAME, credentialsId: 'github-token', url: env.GIT_REPO
            }
        }

        stage('ðŸ“¦ Clean & Install Dependencies') {
            steps {
                echo "ðŸ”¥ Suppression de node_modules et de fichiers de verrouillage"
                sh 'rm -rf node_modules package-lock.json'

                echo "ðŸ“¦ RÃ©installation des dÃ©pendances"
>>>>>>> df0fa71cbf65b7a5e01c74aa12342c91324b0345
                sh 'npm install'
            }
        }

<<<<<<< HEAD
        stage('Run Tests') {
            steps {
                sh 'npm run test'
            }
        }

        stage('Build Frontend') {
            steps {
                sh 'npm run build'
            }
        }

        stage('Build Docker Image') {
            steps {
                sh "docker build -t ${IMAGE_NAME} ./frontend"
            }
        }

        stage('Push Docker Image') {
            steps {
                withDockerRegistry([credentialsId: 'docker-hub-credentials', url: ""]) {
                    sh "docker tag ${IMAGE_NAME} ${DOCKER_REGISTRY}/${IMAGE_NAME}:latest"
                    sh "docker push ${DOCKER_REGISTRY}/${IMAGE_NAME}:latest"
=======
        stage('ðŸ§ª Run Tests') {
            steps {
                echo "ðŸ§ª ExÃ©cution des tests unitaires"
                sh 'npm run test || true'
            }
        }

        stage('ðŸ”Ž SonarQube Analysis') {
            steps {
                withSonarQubeEnv('SonarQube') { // Doit correspondre au nom configurÃ© dans Jenkins
                    sh 'npm install -g sonar-scanner'
                    sh '''
                    sonar-scanner \
                      -Dsonar.projectKey=frontend \
                      -Dsonar.sources=src \
                      -Dsonar.host.url=$SONAR_HOST_URL \
                      -Dsonar.login=$SONAR_TOKEN
                    '''
>>>>>>> df0fa71cbf65b7a5e01c74aa12342c91324b0345
                }
            }
        }

<<<<<<< HEAD
        stage('Deploy') {
            steps {
                sh 'docker-compose down frontend'
                sh 'docker-compose up -d frontend'
            }
        }
    }
}
=======
        stage('âš™ï¸ Build React App') {
            steps {
                echo "âš™ï¸ Construction de l'application React"
                sh 'npm run build'
            }
        }

        stage('ðŸ³ Docker Build') {
            steps {
                echo "ðŸ³ Construction de l'image Docker"
                sh "docker build -f Dockerfile.prod -t ${DOCKER_IMAGE} -t ${DOCKER_TAG_LATEST} ."
            }
        }

        stage('ðŸš€ Deploy to VPS') {
            steps {
                sshagent([env.SSH_CREDENTIALS]) {
                    sh """
                        ssh -o StrictHostKeyChecking=no ${VPS_USER}@${VPS_HOST} << 'EOF'
                        cd ${PROJECT_PATH}
                        docker stop ${CONTAINER_NAME} || true
                        docker rm ${CONTAINER_NAME} || true
                        docker rmi ${DOCKER_TAG_LATEST} || true
                        docker build -f Dockerfile.prod -t ${DOCKER_TAG_LATEST} .
                        docker run -d --name ${CONTAINER_NAME} \
                          --network=web \
                          -e REACT_APP_API_URL=https://www.backend.dsp5-archi-f24a-15m-g8.fr/api \
                          ${DOCKER_TAG_LATEST}
                        EOF
                    """
                }
            }
        }
    }

    post {
        success {
            echo 'âœ… DÃ©ploiement rÃ©ussi'
        }
        failure {
            echo 'âŒ Ã‰chec du pipeline'
        }
    }
}
>>>>>>> df0fa71cbf65b7a5e01c74aa12342c91324b0345
